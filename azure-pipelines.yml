resources:
  containers:
    - container: rust-mkl
      image: rustmath/mkl:latest

jobs:
  - job: 'pkg_config'
    pool:
      vmImage: 'ubuntu-16.04'
    container: rust-mkl
    steps:
      - script: cargo test -v
        displayName: run test

  - job: 'packaging'
    pool:
      vmImage: 'ubuntu-16.04'
    container: rust-mkl
    steps:
      - script: ./package/mkl_linux.sh
        displayName: Package MKL libraries
    variables:
      MKL_DIR: /opt/intel/compilers_and_libraries_2019.3.199/linux/mkl

  - job: Linux
    pool:
      vmImage: 'ubuntu-16.04'
    steps:
      - script: |
          curl -sSf https://sh.rustup.rs | sh -s -- -y
          echo "##vso[task.setvariable variable=PATH;]$PATH:$HOME/.cargo/bin"
        displayName: install rustup
      - script: cargo test -v
        displayName: run test

  - job: macOS
    pool:
      vmImage: 'macOS-10.14'
    steps:
      - script: |
          curl -sSf https://sh.rustup.rs | sh -s -- -y
          echo "##vso[task.setvariable variable=PATH;]$PATH:$HOME/.cargo/bin"
        displayName: install rustup
      - script: cargo test -v
        displayName: run test

  - job: Windows
    pool:
      vmImage: 'windows-2019'
    steps:
      - script: |
          curl -sSf -o rustup-init.exe https://win.rustup.rs
          rustup-init.exe -y 2>&1
          set PATH=%PATH%;%USERPROFILE%\.cargo\bin
          echo '##vso[task.setvariable variable=PATH;]%PATH%;%USERPROFILE%\.cargo\bin'
        displayName: install rustup on Windows
      - script: cargo test -v 2>&1
        displayName: run test
